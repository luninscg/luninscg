<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energiaa CRM - OCR Faturas Energisa</title>
    
    <!-- CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #f8b500;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-danger: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            --shadow-light: 0 2px 10px rgba(0,0,0,0.1);
            --shadow-medium: 0 4px 20px rgba(0,0,0,0.15);
            --shadow-heavy: 0 8px 30px rgba(0,0,0,0.2);
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .container-fluid {
            padding: 20px;
        }

        .ocr-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: var(--shadow-medium);
            padding: 30px;
            margin-bottom: 30px;
        }

        .ocr-card {
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
            border: none;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .ocr-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }

        .upload-zone {
            border: 3px dashed #dee2e6;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #f8f9fa;
        }

        .upload-zone:hover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }

        .upload-zone.dragover {
            border-color: var(--success-color);
            background: rgba(40, 167, 69, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .btn-custom {
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .btn-primary-custom {
            background: var(--gradient-primary);
            border: none;
            color: white;
        }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-success-custom {
            background: var(--gradient-success);
            border: none;
            color: white;
        }

        .btn-danger-custom {
            background: var(--gradient-danger);
            border: none;
            color: white;
        }

        .processing-status {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow-light);
            margin-bottom: 20px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-processing {
            background-color: var(--warning-color);
            animation: pulse 2s infinite;
        }

        .status-completed {
            background-color: var(--success-color);
        }

        .status-error {
            background-color: var(--danger-color);
        }

        .status-pending {
            background-color: var(--info-color);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .progress-custom {
            height: 8px;
            border-radius: 10px;
            background: #e9ecef;
            overflow: hidden;
        }

        .progress-bar-custom {
            background: var(--gradient-success);
            transition: width 0.3s ease;
        }

        .extracted-data {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .data-field {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s ease;
        }

        .data-field:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-light);
        }

        .data-label {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 5px;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }

        .data-value {
            font-size: 1.1rem;
            color: var(--primary-color);
            font-weight: 500;
        }

        .confidence-meter {
            background: #e9ecef;
            border-radius: 10px;
            height: 6px;
            overflow: hidden;
            margin-top: 8px;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .confidence-high {
            background: linear-gradient(90deg, #28a745, #20c997);
        }

        .confidence-medium {
            background: linear-gradient(90deg, #ffc107, #fd7e14);
        }

        .confidence-low {
            background: linear-gradient(90deg, #dc3545, #e83e8c);
        }

        .image-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: var(--shadow-light);
            margin-bottom: 20px;
        }

        .ocr-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow-light);
            text-align: center;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }

        .metric-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin: 0 auto 15px;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--dark-color);
            margin-bottom: 5px;
        }

        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .template-selector {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow-light);
            margin-bottom: 20px;
        }

        .template-option {
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .template-option:hover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }

        .template-option.selected {
            border-color: var(--success-color);
            background: rgba(40, 167, 69, 0.1);
        }

        .template-preview {
            width: 80px;
            height: 100px;
            background: #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #6c757d;
        }

        .history-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow-light);
            max-height: 600px;
            overflow-y: auto;
        }

        .history-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--info-color);
            transition: all 0.3s ease;
        }

        .history-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .history-item.success {
            border-left-color: var(--success-color);
        }

        .history-item.error {
            border-left-color: var(--danger-color);
        }

        .validation-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow-light);
            margin-top: 20px;
        }

        .validation-field {
            margin-bottom: 20px;
        }

        .validation-status {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .validation-valid {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
        }

        .validation-invalid {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
        }

        .validation-warning {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning-color);
        }

        .batch-processing {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow-light);
            margin-bottom: 20px;
        }

        .batch-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .batch-progress {
            flex: 1;
            margin: 0 15px;
        }

        @media (max-width: 768px) {
            .container-fluid {
                padding: 10px;
            }
            
            .ocr-header {
                padding: 20px;
            }
            
            .metric-value {
                font-size: 1.5rem;
            }
            
            .upload-zone {
                padding: 20px;
            }
            
            .upload-icon {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="ocr-header animate__animated animate__fadeInDown">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="fas fa-eye text-primary me-3"></i>
                        OCR Faturas Energisa
                    </h1>
                    <p class="text-muted mb-0">Extração inteligente de dados de faturas de energia elétrica</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-primary-custom btn-custom me-2" onclick="showBatchProcessing()">
                        <i class="fas fa-layer-group me-2"></i>Lote
                    </button>
                    <button class="btn btn-success-custom btn-custom" onclick="showHistory()">
                        <i class="fas fa-history me-2"></i>Histórico
                    </button>
                </div>
            </div>
        </div>

        <!-- OCR Metrics -->
        <div class="ocr-metrics animate__animated animate__fadeInUp">
            <div class="metric-card">
                <div class="metric-icon" style="background: var(--gradient-success);">
                    <i class="fas fa-file-invoice"></i>
                </div>
                <div class="metric-value" id="processed-today">47</div>
                <div class="metric-label">Processadas Hoje</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="background: var(--gradient-primary);">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="metric-value" id="accuracy-rate">96.8%</div>
                <div class="metric-label">Taxa de Precisão</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="background: var(--gradient-secondary);">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="metric-value" id="avg-processing-time">3.2s</div>
                <div class="metric-label">Tempo Médio</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="background: var(--gradient-danger);">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="metric-value" id="success-rate">98.5%</div>
                <div class="metric-label">Taxa de Sucesso</div>
            </div>
        </div>

        <div class="row">
            <!-- Upload and Processing -->
            <div class="col-md-8">
                <!-- Template Selector -->
                <div class="template-selector">
                    <h5 class="mb-3">Selecione o Tipo de Fatura</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="template-option selected" data-template="energisa-padrao">
                                <div class="d-flex align-items-center">
                                    <div class="template-preview me-3">
                                        <i class="fas fa-file-alt"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">Energisa Padrão</h6>
                                        <small class="text-muted">Fatura residencial padrão</small>
                                        <div class="mt-2">
                                            <span class="badge bg-success">97% precisão</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="template-option" data-template="energisa-comercial">
                                <div class="d-flex align-items-center">
                                    <div class="template-preview me-3">
                                        <i class="fas fa-building"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">Energisa Comercial</h6>
                                        <small class="text-muted">Fatura comercial/empresarial</small>
                                        <div class="mt-2">
                                            <span class="badge bg-success">95% precisão</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="template-option" data-template="energisa-industrial">
                                <div class="d-flex align-items-center">
                                    <div class="template-preview me-3">
                                        <i class="fas fa-industry"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">Energisa Industrial</h6>
                                        <small class="text-muted">Fatura industrial/alta tensão</small>
                                        <div class="mt-2">
                                            <span class="badge bg-warning">92% precisão</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Zone -->
                <div class="ocr-card">
                    <div class="card-body p-0">
                        <div class="upload-zone" id="uploadZone">
                            <div class="upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <h4 class="mb-3">Arraste e solte a fatura aqui</h4>
                            <p class="text-muted mb-4">ou clique para selecionar arquivo</p>
                            <button class="btn btn-primary-custom btn-custom" onclick="selectFile()">
                                <i class="fas fa-folder-open me-2"></i>Selecionar Arquivo
                            </button>
                            <input type="file" id="fileInput" accept="image/*,.pdf" style="display: none;" multiple>
                            <div class="mt-3">
                                <small class="text-muted">
                                    Formatos suportados: JPG, PNG, PDF • Tamanho máximo: 10MB
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Processing Status -->
                <div class="processing-status" id="processingStatus" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <span class="status-indicator status-processing" id="statusIndicator"></span>
                            Processando Fatura
                        </h5>
                        <span class="badge bg-primary" id="processingStage">Analisando imagem...</span>
                    </div>
                    <div class="progress progress-custom mb-3">
                        <div class="progress-bar progress-bar-custom" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">Tempo decorrido:</small>
                            <div class="fw-bold" id="elapsedTime">0s</div>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">Etapa atual:</small>
                            <div class="fw-bold" id="currentStage">Preparando...</div>
                        </div>
                    </div>
                </div>

                <!-- Image Preview -->
                <div class="ocr-card" id="imagePreviewCard" style="display: none;">
                    <div class="card-body">
                        <h5 class="mb-3">Imagem Carregada</h5>
                        <img id="imagePreview" class="image-preview" alt="Preview da fatura">
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                <small class="text-muted">Arquivo:</small>
                                <div class="fw-bold" id="fileName">-</div>
                            </div>
                            <div>
                                <small class="text-muted">Tamanho:</small>
                                <div class="fw-bold" id="fileSize">-</div>
                            </div>
                            <button class="btn btn-success-custom btn-custom" onclick="processImage()">
                                <i class="fas fa-play me-2"></i>Processar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Extracted Data -->
                <div class="extracted-data" id="extractedData" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0">Dados Extraídos</h5>
                        <div>
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="editData()">
                                <i class="fas fa-edit me-1"></i>Editar
                            </button>
                            <button class="btn btn-outline-success btn-sm me-2" onclick="validateData()">
                                <i class="fas fa-check me-1"></i>Validar
                            </button>
                            <button class="btn btn-success-custom btn-sm" onclick="saveData()">
                                <i class="fas fa-save me-1"></i>Salvar
                            </button>
                        </div>
                    </div>
                    
                    <div class="row" id="dataFields">
                        <!-- Data fields will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-md-4">
                <!-- Validation Panel -->
                <div class="validation-panel">
                    <h5 class="mb-3">
                        <i class="fas fa-shield-alt text-success me-2"></i>
                        Validação de Dados
                    </h5>
                    <div id="validationResults">
                        <div class="text-center text-muted">
                            <i class="fas fa-info-circle fa-2x mb-3"></i>
                            <p>Processe uma fatura para ver a validação</p>
                        </div>
                    </div>
                </div>

                <!-- Processing History -->
                <div class="history-panel mt-4">
                    <h5 class="mb-3">
                        <i class="fas fa-history text-info me-2"></i>
                        Histórico Recente
                    </h5>
                    <div id="historyList">
                        <div class="history-item success">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>Fatura_202312_001.pdf</strong>
                                <small class="text-muted">2 min atrás</small>
                            </div>
                            <p class="mb-2">Processamento concluído com sucesso</p>
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-success">97% confiança</span>
                                <button class="btn btn-outline-primary btn-sm" onclick="viewProcessedData('001')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="history-item success">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>Fatura_202311_045.jpg</strong>
                                <small class="text-muted">15 min atrás</small>
                            </div>
                            <p class="mb-2">Dados extraídos e validados</p>
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-success">94% confiança</span>
                                <button class="btn btn-outline-primary btn-sm" onclick="viewProcessedData('045')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="history-item error">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>Fatura_202311_032.png</strong>
                                <small class="text-muted">1 hora atrás</small>
                            </div>
                            <p class="mb-2">Erro na extração - imagem ilegível</p>
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-danger">Falhou</span>
                                <button class="btn btn-outline-warning btn-sm" onclick="retryProcessing('032')">
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="history-item success">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>Fatura_202311_028.pdf</strong>
                                <small class="text-muted">2 horas atrás</small>
                            </div>
                            <p class="mb-2">Processamento comercial concluído</p>
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-success">96% confiança</span>
                                <button class="btn btn-outline-primary btn-sm" onclick="viewProcessedData('028')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Batch Processing Modal -->
    <div class="modal fade" id="batchModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--gradient-primary); color: white;">
                    <h5 class="modal-title">Processamento em Lote</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="batch-processing">
                        <div class="upload-zone" id="batchUploadZone">
                            <div class="upload-icon">
                                <i class="fas fa-layer-group"></i>
                            </div>
                            <h5 class="mb-3">Selecione múltiplas faturas</h5>
                            <p class="text-muted mb-4">Arraste e solte ou clique para selecionar</p>
                            <button class="btn btn-primary-custom btn-custom" onclick="selectBatchFiles()">
                                <i class="fas fa-folder-open me-2"></i>Selecionar Arquivos
                            </button>
                            <input type="file" id="batchFileInput" accept="image/*,.pdf" style="display: none;" multiple>
                        </div>
                        
                        <div id="batchFileList" style="display: none;">
                            <h6 class="mt-4 mb-3">Arquivos Selecionados</h6>
                            <div id="batchFiles"></div>
                            <div class="mt-3">
                                <button class="btn btn-success-custom btn-custom" onclick="processBatch()">
                                    <i class="fas fa-play me-2"></i>Processar Lote
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Editor Modal -->
    <div class="modal fade" id="dataEditorModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--gradient-primary); color: white;">
                    <h5 class="modal-title">Editor de Dados Extraídos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Dados Originais</h6>
                            <div id="originalData" class="border rounded p-3" style="height: 400px; overflow-y: auto;"></div>
                        </div>
                        <div class="col-md-6">
                            <h6>Dados Editados</h6>
                            <div id="editableData" style="height: 400px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="saveEditedData()">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // OCR Management System
        class OCRManager {
            constructor() {
                this.currentFile = null;
                this.extractedData = null;
                this.processingTimer = null;
                this.selectedTemplate = 'energisa-padrao';
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.updateMetrics();
            }

            setupEventListeners() {
                // File input
                const fileInput = document.getElementById('fileInput');
                fileInput.addEventListener('change', (e) => this.handleFileSelect(e));

                // Drag and drop
                const uploadZone = document.getElementById('uploadZone');
                uploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadZone.classList.add('dragover');
                });

                uploadZone.addEventListener('dragleave', () => {
                    uploadZone.classList.remove('dragover');
                });

                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragover');
                    this.handleFileSelect({ target: { files: e.dataTransfer.files } });
                });

                // Template selection
                document.querySelectorAll('.template-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        document.querySelectorAll('.template-option').forEach(o => o.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                        this.selectedTemplate = e.currentTarget.dataset.template;
                    });
                });

                // Batch file input
                const batchFileInput = document.getElementById('batchFileInput');
                batchFileInput.addEventListener('change', (e) => this.handleBatchFileSelect(e));
            }

            handleFileSelect(event) {
                const files = event.target.files;
                if (files.length > 0) {
                    this.currentFile = files[0];
                    this.showImagePreview(files[0]);
                }
            }

            showImagePreview(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    
                    document.getElementById('fileName').textContent = file.name;
                    document.getElementById('fileSize').textContent = this.formatFileSize(file.size);
                    
                    document.getElementById('imagePreviewCard').style.display = 'block';
                    document.getElementById('extractedData').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }

            async processImage() {
                if (!this.currentFile) {
                    this.showNotification('Selecione um arquivo primeiro', 'warning');
                    return;
                }

                this.showProcessingStatus();
                await this.simulateOCRProcessing();
                this.showExtractedData();
            }

            showProcessingStatus() {
                document.getElementById('processingStatus').style.display = 'block';
                document.getElementById('imagePreviewCard').style.display = 'none';
                
                const statusIndicator = document.getElementById('statusIndicator');
                statusIndicator.className = 'status-indicator status-processing';
                
                let elapsed = 0;
                this.processingTimer = setInterval(() => {
                    elapsed++;
                    document.getElementById('elapsedTime').textContent = elapsed + 's';
                }, 1000);
            }

            async simulateOCRProcessing() {
                const stages = [
                    { name: 'Preparando imagem...', progress: 10 },
                    { name: 'Detectando texto...', progress: 30 },
                    { name: 'Extraindo dados...', progress: 60 },
                    { name: 'Validando informações...', progress: 80 },
                    { name: 'Finalizando...', progress: 100 }
                ];

                for (const stage of stages) {
                    document.getElementById('processingStage').textContent = stage.name;
                    document.getElementById('currentStage').textContent = stage.name;
                    document.getElementById('progressBar').style.width = stage.progress + '%';
                    
                    await this.sleep(800 + Math.random() * 1200);
                }

                clearInterval(this.processingTimer);
                
                const statusIndicator = document.getElementById('statusIndicator');
                statusIndicator.className = 'status-indicator status-completed';
                document.getElementById('processingStage').textContent = 'Concluído!';
            }

            showExtractedData() {
                // Generate mock extracted data based on template
                this.extractedData = this.generateMockData();
                
                document.getElementById('processingStatus').style.display = 'none';
                document.getElementById('extractedData').style.display = 'block';
                
                this.populateDataFields();
                this.showValidationResults();
                this.updateMetrics();
            }

            generateMockData() {
                const baseData = {
                    'cliente-nome': { value: 'JOÃO SILVA SANTOS', confidence: 0.98 },
                    'cliente-cpf': { value: '123.456.789-01', confidence: 0.95 },
                    'endereco': { value: 'RUA DAS FLORES, 123 - CENTRO', confidence: 0.92 },
                    'numero-instalacao': { value: '12345678901', confidence: 0.99 },
                    'numero-cliente': { value: '987654321', confidence: 0.97 },
                    'mes-referencia': { value: 'DEZ/2023', confidence: 0.96 },
                    'data-vencimento': { value: '15/01/2024', confidence: 0.94 },
                    'consumo-kwh': { value: '450', confidence: 0.93 },
                    'valor-total': { value: 'R$ 387,45', confidence: 0.91 },
                    'valor-energia': { value: 'R$ 298,32', confidence: 0.89 },
                    'valor-icms': { value: 'R$ 45,67', confidence: 0.87 },
                    'valor-pis-cofins': { value: 'R$ 23,45', confidence: 0.85 },
                    'bandeira-tarifaria': { value: 'VERDE', confidence: 0.88 },
                    'classe': { value: 'RESIDENCIAL', confidence: 0.96 },
                    'grupo': { value: 'B1', confidence: 0.94 }
                };

                // Adjust data based on template
                if (this.selectedTemplate === 'energisa-comercial') {
                    baseData['cliente-nome'].value = 'EMPRESA EXEMPLO LTDA';
                    baseData['cliente-cpf'] = { value: '12.345.678/0001-90', confidence: 0.96 };
                    baseData['classe'].value = 'COMERCIAL';
                    baseData['grupo'].value = 'B3';
                    baseData['consumo-kwh'].value = '1250';
                    baseData['valor-total'].value = 'R$ 1.245,67';
                } else if (this.selectedTemplate === 'energisa-industrial') {
                    baseData['cliente-nome'].value = 'INDÚSTRIA EXEMPLO S.A.';
                    baseData['cliente-cpf'] = { value: '98.765.432/0001-10', confidence: 0.97 };
                    baseData['classe'].value = 'INDUSTRIAL';
                    baseData['grupo'].value = 'A4';
                    baseData['consumo-kwh'].value = '15750';
                    baseData['valor-total'].value = 'R$ 8.945,32';
                }

                return baseData;
            }

            populateDataFields() {
                const container = document.getElementById('dataFields');
                container.innerHTML = '';

                const fieldLabels = {
                    'cliente-nome': 'Nome do Cliente',
                    'cliente-cpf': 'CPF/CNPJ',
                    'endereco': 'Endereço',
                    'numero-instalacao': 'Número da Instalação',
                    'numero-cliente': 'Número do Cliente',
                    'mes-referencia': 'Mês de Referência',
                    'data-vencimento': 'Data de Vencimento',
                    'consumo-kwh': 'Consumo (kWh)',
                    'valor-total': 'Valor Total',
                    'valor-energia': 'Valor da Energia',
                    'valor-icms': 'ICMS',
                    'valor-pis-cofins': 'PIS/COFINS',
                    'bandeira-tarifaria': 'Bandeira Tarifária',
                    'classe': 'Classe',
                    'grupo': 'Grupo'
                };

                Object.entries(this.extractedData).forEach(([key, data]) => {
                    const col = document.createElement('div');
                    col.className = 'col-md-6';
                    
                    const confidenceClass = data.confidence >= 0.9 ? 'confidence-high' : 
                                           data.confidence >= 0.7 ? 'confidence-medium' : 'confidence-low';
                    
                    col.innerHTML = `
                        <div class="data-field">
                            <div class="data-label">${fieldLabels[key] || key}</div>
                            <div class="data-value">${data.value}</div>
                            <div class="confidence-meter">
                                <div class="confidence-fill ${confidenceClass}" style="width: ${data.confidence * 100}%"></div>
                            </div>
                            <small class="text-muted">Confiança: ${(data.confidence * 100).toFixed(1)}%</small>
                        </div>
                    `;
                    
                    container.appendChild(col);
                });
            }

            showValidationResults() {
                const container = document.getElementById('validationResults');
                const validations = [
                    { field: 'CPF/CNPJ', status: 'valid', message: 'Formato válido' },
                    { field: 'Data Vencimento', status: 'valid', message: 'Data futura válida' },
                    { field: 'Valor Total', status: 'valid', message: 'Formato monetário correto' },
                    { field: 'Consumo kWh', status: 'warning', message: 'Valor alto para residencial' },
                    { field: 'Número Instalação', status: 'valid', message: 'Formato Energisa válido' }
                ];

                container.innerHTML = validations.map(v => `
                    <div class="validation-field">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold">${v.field}</span>
                            <span class="validation-status validation-${v.status}">
                                <i class="fas fa-${v.status === 'valid' ? 'check' : v.status === 'warning' ? 'exclamation-triangle' : 'times'}"></i>
                                ${v.status === 'valid' ? 'Válido' : v.status === 'warning' ? 'Atenção' : 'Inválido'}
                            </span>
                        </div>
                        <small class="text-muted">${v.message}</small>
                    </div>
                `).join('');
            }

            handleBatchFileSelect(event) {
                const files = Array.from(event.target.files);
                if (files.length > 0) {
                    this.showBatchFileList(files);
                }
            }

            showBatchFileList(files) {
                const container = document.getElementById('batchFiles');
                container.innerHTML = '';

                files.forEach((file, index) => {
                    const item = document.createElement('div');
                    item.className = 'batch-item';
                    item.innerHTML = `
                        <div>
                            <strong>${file.name}</strong>
                            <br><small class="text-muted">${this.formatFileSize(file.size)}</small>
                        </div>
                        <div class="batch-progress">
                            <div class="progress progress-custom">
                                <div class="progress-bar progress-bar-custom" style="width: 0%"></div>
                            </div>
                        </div>
                        <span class="badge bg-secondary">Aguardando</span>
                    `;
                    container.appendChild(item);
                });

                document.getElementById('batchFileList').style.display = 'block';
            }

            async processBatch() {
                const items = document.querySelectorAll('.batch-item');
                
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    const progressBar = item.querySelector('.progress-bar');
                    const badge = item.querySelector('.badge');
                    
                    badge.textContent = 'Processando...';
                    badge.className = 'badge bg-warning';
                    
                    // Simulate processing
                    for (let progress = 0; progress <= 100; progress += 10) {
                        progressBar.style.width = progress + '%';
                        await this.sleep(100);
                    }
                    
                    badge.textContent = 'Concluído';
                    badge.className = 'badge bg-success';
                }
                
                this.showNotification('Processamento em lote concluído!', 'success');
            }

            updateMetrics() {
                // Simulate metric updates
                const metrics = {
                    'processed-today': () => Math.floor(Math.random() * 10) + 40,
                    'accuracy-rate': () => (95 + Math.random() * 4).toFixed(1) + '%',
                    'avg-processing-time': () => (2.5 + Math.random() * 2).toFixed(1) + 's',
                    'success-rate': () => (97 + Math.random() * 2).toFixed(1) + '%'
                };

                Object.entries(metrics).forEach(([id, generator]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = generator();
                    }
                });
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                notification.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 5000);
            }
        }

        // Global functions
        let ocrManager;

        function selectFile() {
            document.getElementById('fileInput').click();
        }

        function processImage() {
            ocrManager.processImage();
        }

        function editData() {
            const modal = new bootstrap.Modal(document.getElementById('dataEditorModal'));
            modal.show();
            
            // Populate editor with current data
            const originalData = document.getElementById('originalData');
            const editableData = document.getElementById('editableData');
            
            originalData.innerHTML = '<pre>' + JSON.stringify(ocrManager.extractedData, null, 2) + '</pre>';
            
            let editableHTML = '';
            Object.entries(ocrManager.extractedData).forEach(([key, data]) => {
                editableHTML += `
                    <div class="mb-3">
                        <label class="form-label">${key}</label>
                        <input type="text" class="form-control" value="${data.value}" data-field="${key}">
                    </div>
                `;
            });
            editableData.innerHTML = editableHTML;
        }

        function validateData() {
            ocrManager.showValidationResults();
            ocrManager.showNotification('Validação executada com sucesso!', 'success');
        }

        function saveData() {
            ocrManager.showNotification('Dados salvos com sucesso!', 'success');
        }

        function saveEditedData() {
            const inputs = document.querySelectorAll('#editableData input');
            inputs.forEach(input => {
                const field = input.dataset.field;
                if (ocrManager.extractedData[field]) {
                    ocrManager.extractedData[field].value = input.value;
                }
            });
            
            ocrManager.populateDataFields();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('dataEditorModal'));
            modal.hide();
            
            ocrManager.showNotification('Dados atualizados com sucesso!', 'success');
        }

        function showBatchProcessing() {
            const modal = new bootstrap.Modal(document.getElementById('batchModal'));
            modal.show();
        }

        function selectBatchFiles() {
            document.getElementById('batchFileInput').click();
        }

        function processBatch() {
            ocrManager.processBatch();
        }

        function showHistory() {
            ocrManager.showNotification('Histórico completo carregado', 'info');
        }

        function viewProcessedData(id) {
            ocrManager.showNotification(`Visualizando dados do processamento ${id}`, 'info');
        }

        function retryProcessing(id) {
            ocrManager.showNotification(`Reprocessando arquivo ${id}...`, 'warning');
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            ocrManager = new OCRManager();
            
            // Update metrics every 30 seconds
            setInterval(() => {
                ocrManager.updateMetrics();
            }, 30000);
        });
    </script>
</body>
</html>