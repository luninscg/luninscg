<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energiaa CRM - Sistema de Testes Avançado</title>
    
    <!-- CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #f8b500;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-danger: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            --shadow-light: 0 2px 10px rgba(0,0,0,0.1);
            --shadow-medium: 0 4px 20px rgba(0,0,0,0.15);
            --shadow-heavy: 0 8px 30px rgba(0,0,0,0.2);
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .container-fluid {
            padding: 20px;
        }

        .test-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: var(--shadow-medium);
            padding: 30px;
            margin-bottom: 30px;
        }

        .test-suite-card {
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
            border: none;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .test-suite-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }

        .test-suite-header {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .test-suite-body {
            padding: 20px;
        }

        .test-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-pending { background-color: #6c757d; }
        .status-running { background-color: var(--warning-color); animation: pulse 2s infinite; }
        .status-passed { background-color: var(--success-color); }
        .status-failed { background-color: var(--danger-color); }
        .status-skipped { background-color: var(--info-color); }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .progress-custom {
            height: 8px;
            border-radius: 10px;
            background-color: #e9ecef;
            overflow: hidden;
        }

        .progress-bar-custom {
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .test-result {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid var(--info-color);
        }

        .test-result.passed {
            border-left-color: var(--success-color);
            background: #d4edda;
        }

        .test-result.failed {
            border-left-color: var(--danger-color);
            background: #f8d7da;
        }

        .test-log {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .test-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow-light);
            text-align: center;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }

        .metric-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin: 0 auto 15px;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--dark-color);
            margin-bottom: 5px;
        }

        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-custom {
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .btn-primary-custom {
            background: var(--gradient-primary);
            border: none;
            color: white;
        }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-success-custom {
            background: var(--gradient-success);
            border: none;
            color: white;
        }

        .btn-danger-custom {
            background: var(--gradient-danger);
            border: none;
            color: white;
        }

        .test-controls {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow-light);
            margin-bottom: 30px;
        }

        .test-filter {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .filter-chip {
            background: #e9ecef;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-chip.active {
            background: var(--gradient-primary);
            color: white;
        }

        .test-timeline {
            position: relative;
            padding-left: 30px;
        }

        .test-timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e9ecef;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: var(--shadow-light);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -22px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary-color);
        }

        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            box-shadow: var(--shadow-heavy);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal-custom .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: var(--shadow-heavy);
        }

        .modal-custom .modal-header {
            background: var(--gradient-primary);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .tab-content {
            background: white;
            border-radius: 0 15px 15px 15px;
            padding: 25px;
            box-shadow: var(--shadow-light);
        }

        .nav-tabs {
            border: none;
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 15px 15px 0 0;
            background: #f8f9fa;
            color: var(--dark-color);
            margin-right: 5px;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link.active {
            background: white;
            color: var(--primary-color);
            box-shadow: var(--shadow-light);
        }

        @media (max-width: 768px) {
            .container-fluid {
                padding: 10px;
            }
            
            .test-header {
                padding: 20px;
            }
            
            .metric-value {
                font-size: 1.5rem;
            }
            
            .test-filter {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="test-header animate__animated animate__fadeInDown">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="fas fa-vial text-primary me-3"></i>
                        Sistema de Testes Avançado
                    </h1>
                    <p class="text-muted mb-0">Execução, monitoramento e análise completa de testes do CRM</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-primary-custom btn-custom me-2" onclick="runAllTests()">
                        <i class="fas fa-play me-2"></i>Executar Todos
                    </button>
                    <button class="btn btn-success-custom btn-custom" onclick="generateReport()">
                        <i class="fas fa-file-alt me-2"></i>Relatório
                    </button>
                </div>
            </div>
        </div>

        <!-- Test Metrics -->
        <div class="test-metrics animate__animated animate__fadeInUp">
            <div class="metric-card">
                <div class="metric-icon" style="background: var(--gradient-success);">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="metric-value" id="tests-passed">0</div>
                <div class="metric-label">Testes Aprovados</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="background: var(--gradient-danger);">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="metric-value" id="tests-failed">0</div>
                <div class="metric-label">Testes Falharam</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="background: var(--gradient-primary);">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="metric-value" id="test-duration">0s</div>
                <div class="metric-label">Duração Total</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="background: var(--gradient-secondary);">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="metric-value" id="test-coverage">0%</div>
                <div class="metric-label">Cobertura</div>
            </div>
        </div>

        <!-- Test Controls -->
        <div class="test-controls animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
            <div class="row">
                <div class="col-md-8">
                    <h5 class="mb-3">Filtros de Teste</h5>
                    <div class="test-filter">
                        <button class="filter-chip active" data-filter="all">Todos</button>
                        <button class="filter-chip" data-filter="integration">Integração</button>
                        <button class="filter-chip" data-filter="unit">Unitários</button>
                        <button class="filter-chip" data-filter="api">API</button>
                        <button class="filter-chip" data-filter="performance">Performance</button>
                        <button class="filter-chip" data-filter="security">Segurança</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <h5 class="mb-3">Configurações</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="parallelExecution" checked>
                        <label class="form-check-label" for="parallelExecution">
                            Execução Paralela
                        </label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="verboseOutput">
                        <label class="form-check-label" for="verboseOutput">
                            Saída Detalhada
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Suites -->
        <div class="row">
            <div class="col-md-8">
                <div id="test-suites-container">
                    <!-- WhatsApp Integration Tests -->
                    <div class="test-suite-card animate__animated animate__fadeInLeft" data-category="integration">
                        <div class="test-suite-header">
                            <div>
                                <h5 class="mb-1">
                                    <span class="test-status status-pending"></span>
                                    Integração WhatsApp
                                </h5>
                                <small class="text-muted">Testes de conectividade e envio de mensagens</small>
                            </div>
                            <div>
                                <button class="btn btn-outline-primary btn-sm" onclick="runTestSuite('whatsapp')">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="viewTestDetails('whatsapp')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="test-suite-body">
                            <div class="progress progress-custom mb-3">
                                <div class="progress-bar progress-bar-custom bg-primary" style="width: 0%"></div>
                            </div>
                            <div class="row">
                                <div class="col-4 text-center">
                                    <small class="text-muted">Testes</small>
                                    <div class="fw-bold">12</div>
                                </div>
                                <div class="col-4 text-center">
                                    <small class="text-muted">Aprovados</small>
                                    <div class="fw-bold text-success">0</div>
                                </div>
                                <div class="col-4 text-center">
                                    <small class="text-muted">Falharam</small>
                                    <div class="fw-bold text-danger">0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Processing Tests -->
                    <div class="test-suite-card animate__animated animate__fadeInLeft" style="animation-delay: 0.1s;" data-category="integration">
                        <div class="test-suite-header">
                            <div>
                                <h5 class="mb-1">
                                    <span class="test-status status-pending"></span>
                                    Processamento IA
                                </h5>
                                <small class="text-muted">Testes de prompts e respostas da OpenAI</small>
                            </div>
                            <div>
                                <button class="btn btn-outline-primary btn-sm" onclick="runTestSuite('ai')">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="viewTestDetails('ai')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="test-suite-body">
                            <div class="progress progress-custom mb-3">
                                <div class="progress-bar progress-bar-custom bg-info" style="width: 0%"></div>
                            </div>
                            <div class="row">
                                <div class="col-4 text-center">
                                    <small class="text-muted">Testes</small>
                                    <div class="fw-bold">8</div>
                                </div>
                                <div class="col-4 text-center">
                                    <small class="text-muted">Aprovados</small>
                                    <div class="fw-bold text-success">0</div>
                                </div>
                                <div class="col-4 text-center">
                                    <small class="text-muted">Falharam</small>
                                    <div class="fw-bold text-danger">0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- OCR Tests -->
                    <div class="test-suite-card animate__animated animate__fadeInLeft" style="animation-delay: 0.2s;" data-category="integration">
                        <div class="test-suite-header">
                            <div>
                                <h5 class="mb-1">
                                    <span class="test-status status-pending"></span>
                                    OCR Faturas
                                </h5>
                                <small class="text-muted">Testes de extração de dados de faturas</small>
                            </div>
                            <div>
                                <button class="btn btn-outline-primary btn-sm" onclick="runTestSuite('ocr')">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="viewTestDetails('ocr')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="test-suite-body">
                            <div class="progress progress-custom mb-3">
                                <div class="progress-bar progress-bar-custom bg-warning" style="width: 0%"></div>
                            </div>
                            <div class="row">
                                <div class="col-4 text-center">
                                    <small class="text-muted">Testes</small>
                                    <div class="fw-bold">15</div>
                                </div>
                                <div class="col-4 text-center">
                                    <small class="text-muted">Aprovados</small>
                                    <div class="fw-bold text-success">0</div>
                                </div>
                                <div class="col-4 text-center">
                                    <small class="text-muted">Falharam</small>
                                    <div class="fw-bold text-danger">0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Proposal Generation Tests -->
                    <div class="test-suite-card animate__animated animate__fadeInLeft" style="animation-delay: 0.3s;" data-category="integration">
                        <div class="test-suite-header">
                            <div>
                                <h5 class="mb-1">
                                    <span class="test-status status-pending"></span>
                                    Geração de Propostas
                                </h5>
                                <small class="text-muted">Testes de criação e formatação de propostas</small>
                            </div>
                            <div>
                                <button class="btn btn-outline-primary btn-sm" onclick="runTestSuite('proposals')">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="viewTestDetails('proposals')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="test-suite-body">
                            <div class="progress progress-custom mb-3">
                                <div class="progress-bar progress-bar-custom bg-success" style="width: 0%"></div>
                            </div>
                            <div class="row">
                                <div class="col-4 text-center">
                                    <small class="text-muted">Testes</small>
                                    <div class="fw-bold">10</div>
                                </div>
                                <div class="col-4 text-center">
                                    <small class="text-muted">Aprovados</small>
                                    <div class="fw-bold text-success">0</div>
                                </div>
                                <div class="col-4 text-center">
                                    <small class="text-muted">Falharam</small>
                                    <div class="fw-bold text-danger">0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- API Tests -->
                    <div class="test-suite-card animate__animated animate__fadeInLeft" style="animation-delay: 0.4s;" data-category="api">
                        <div class="test-suite-header">
                            <div>
                                <h5 class="mb-1">
                                    <span class="test-status status-pending"></span>
                                    Endpoints API
                                </h5>
                                <small class="text-muted">Testes de todas as rotas da API</small>
                            </div>
                            <div>
                                <button class="btn btn-outline-primary btn-sm" onclick="runTestSuite('api')">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="viewTestDetails('api')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="test-suite-body">
                            <div class="progress progress-custom mb-3">
                                <div class="progress-bar progress-bar-custom bg-danger" style="width: 0%"></div>
                            </div>
                            <div class="row">
                                <div class="col-4 text-center">
                                    <small class="text-muted">Testes</small>
                                    <div class="fw-bold">25</div>
                                </div>
                                <div class="col-4 text-center">
                                    <small class="text-muted">Aprovados</small>
                                    <div class="fw-bold text-success">0</div>
                                </div>
                                <div class="col-4 text-center">
                                    <small class="text-muted">Falharam</small>
                                    <div class="fw-bold text-danger">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Timeline & Logs -->
            <div class="col-md-4">
                <div class="test-controls">
                    <ul class="nav nav-tabs" id="testTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline" type="button" role="tab">
                                <i class="fas fa-history me-2"></i>Timeline
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">
                                <i class="fas fa-terminal me-2"></i>Logs
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="coverage-tab" data-bs-toggle="tab" data-bs-target="#coverage" type="button" role="tab">
                                <i class="fas fa-chart-pie me-2"></i>Cobertura
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content" id="testTabContent">
                        <div class="tab-pane fade show active" id="timeline" role="tabpanel">
                            <div class="test-timeline" id="test-timeline">
                                <div class="timeline-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>Sistema inicializado</span>
                                        <small class="text-muted">10:30:15</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="logs" role="tabpanel">
                            <div class="test-log" id="test-logs">
                                <div>[10:30:15] Sistema de testes inicializado</div>
                                <div>[10:30:16] Carregando suítes de teste...</div>
                                <div>[10:30:17] Pronto para execução</div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="coverage" role="tabpanel">
                            <div class="text-center">
                                <canvas id="coverageChart" width="300" height="300"></canvas>
                            </div>
                            <div class="mt-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Statements</span>
                                    <span class="fw-bold">85%</span>
                                </div>
                                <div class="progress progress-custom mb-3">
                                    <div class="progress-bar bg-success" style="width: 85%"></div>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Branches</span>
                                    <span class="fw-bold">78%</span>
                                </div>
                                <div class="progress progress-custom mb-3">
                                    <div class="progress-bar bg-warning" style="width: 78%"></div>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Functions</span>
                                    <span class="fw-bold">92%</span>
                                </div>
                                <div class="progress progress-custom">
                                    <div class="progress-bar bg-success" style="width: 92%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h5>Executando Testes</h5>
            <p class="text-muted mb-0">Aguarde enquanto os testes são executados...</p>
            <div class="mt-3">
                <div class="progress progress-custom">
                    <div class="progress-bar progress-bar-custom bg-primary" id="globalProgress" style="width: 0%"></div>
                </div>
                <small class="text-muted" id="progressText">Iniciando...</small>
            </div>
        </div>
    </div>

    <!-- Test Details Modal -->
    <div class="modal fade modal-custom" id="testDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes do Teste</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="testDetailsContent">
                        <!-- Content will be loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <script>
        // Test System Controller
        class TestSystemController {
            constructor() {
                this.testSuites = new Map();
                this.runningTests = new Set();
                this.testResults = new Map();
                this.startTime = null;
                this.coverageChart = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.initializeCharts();
                this.loadTestSuites();
                this.updateMetrics();
            }

            setupEventListeners() {
                // Filter chips
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.addEventListener('click', (e) => {
                        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                        e.target.classList.add('active');
                        this.filterTests(e.target.dataset.filter);
                    });
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 'Enter':
                                e.preventDefault();
                                this.runAllTests();
                                break;
                            case 'r':
                                e.preventDefault();
                                this.generateReport();
                                break;
                        }
                    }
                });
            }

            loadTestSuites() {
                const suites = [
                    {
                        id: 'whatsapp',
                        name: 'Integração WhatsApp',
                        category: 'integration',
                        tests: [
                            'Conectividade com API',
                            'Envio de mensagem simples',
                            'Envio de mensagem com mídia',
                            'Recebimento de mensagens',
                            'Webhook funcionando',
                            'Rate limiting',
                            'Reconexão automática',
                            'Validação de número',
                            'Status de entrega',
                            'Grupos e contatos',
                            'QR Code geração',
                            'Sessão persistente'
                        ]
                    },
                    {
                        id: 'ai',
                        name: 'Processamento IA',
                        category: 'integration',
                        tests: [
                            'Conexão OpenAI API',
                            'Qualificação de leads',
                            'Análise de sentimento',
                            'Classificação de intenção',
                            'Geração de respostas',
                            'Prompt customizado',
                            'Rate limiting IA',
                            'Fallback messages'
                        ]
                    },
                    {
                        id: 'ocr',
                        name: 'OCR Faturas',
                        category: 'integration',
                        tests: [
                            'Inicialização Tesseract',
                            'Processamento PDF',
                            'Processamento imagem',
                            'Extração dados cliente',
                            'Extração consumo',
                            'Extração valores',
                            'Validação dados',
                            'Associação cliente',
                            'Processamento lote',
                            'Limpeza arquivos',
                            'Estatísticas OCR',
                            'Templates Energisa',
                            'Pré-processamento',
                            'Regex patterns',
                            'Error handling'
                        ]
                    },
                    {
                        id: 'proposals',
                        name: 'Geração de Propostas',
                        category: 'integration',
                        tests: [
                            'Template loading',
                            'Handlebars helpers',
                            'Dados preparação',
                            'Renderização HTML',
                            'Geração PDF',
                            'Salvamento arquivo',
                            'Histórico cliente',
                            'Numeração única',
                            'Validação dados',
                            'Templates múltiplos'
                        ]
                    },
                    {
                        id: 'api',
                        name: 'Endpoints API',
                        category: 'api',
                        tests: [
                            'GET /api/clients',
                            'POST /api/clients',
                            'PUT /api/clients/:id',
                            'DELETE /api/clients/:id',
                            'GET /api/campaigns',
                            'POST /api/campaigns',
                            'GET /api/proposals',
                            'POST /api/proposals',
                            'POST /api/ocr/process',
                            'GET /api/prompts',
                            'POST /api/prompts',
                            'PUT /api/prompts/:id',
                            'POST /api/tests/run',
                            'GET /api/tests/results',
                            'Authentication middleware',
                            'Authorization middleware',
                            'Rate limiting',
                            'Input validation',
                            'Error handling',
                            'CORS configuration',
                            'Request logging',
                            'Response formatting',
                            'File upload',
                            'Pagination',
                            'Health check'
                        ]
                    }
                ];

                suites.forEach(suite => {
                    this.testSuites.set(suite.id, suite);
                });
            }

            filterTests(filter) {
                const cards = document.querySelectorAll('.test-suite-card');
                cards.forEach(card => {
                    if (filter === 'all' || card.dataset.category === filter) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }

            async runTestSuite(suiteId) {
                if (this.runningTests.has(suiteId)) {
                    this.showNotification('Teste já está em execução', 'warning');
                    return;
                }

                this.runningTests.add(suiteId);
                const suite = this.testSuites.get(suiteId);
                const card = document.querySelector(`[data-category="${suite.category}"]`);
                const statusIndicator = card.querySelector('.test-status');
                const progressBar = card.querySelector('.progress-bar');
                const passedCount = card.querySelector('.text-success');
                const failedCount = card.querySelector('.text-danger');

                // Update status to running
                statusIndicator.className = 'test-status status-running';
                
                this.addToTimeline(`Iniciando ${suite.name}`);
                this.addToLogs(`[${this.getCurrentTime()}] Executando ${suite.name}...`);

                let passed = 0;
                let failed = 0;

                for (let i = 0; i < suite.tests.length; i++) {
                    const test = suite.tests[i];
                    const progress = ((i + 1) / suite.tests.length) * 100;
                    
                    progressBar.style.width = `${progress}%`;
                    
                    this.addToLogs(`[${this.getCurrentTime()}] Executando: ${test}`);
                    
                    // Simulate test execution
                    await this.sleep(Math.random() * 1000 + 500);
                    
                    const success = Math.random() > 0.2; // 80% success rate
                    
                    if (success) {
                        passed++;
                        this.addToLogs(`[${this.getCurrentTime()}] ✓ ${test} - PASSOU`);
                    } else {
                        failed++;
                        this.addToLogs(`[${this.getCurrentTime()}] ✗ ${test} - FALHOU`);
                    }
                    
                    passedCount.textContent = passed;
                    failedCount.textContent = failed;
                }

                // Update final status
                if (failed === 0) {
                    statusIndicator.className = 'test-status status-passed';
                    progressBar.className = 'progress-bar progress-bar-custom bg-success';
                } else {
                    statusIndicator.className = 'test-status status-failed';
                    progressBar.className = 'progress-bar progress-bar-custom bg-danger';
                }

                this.testResults.set(suiteId, { passed, failed, total: suite.tests.length });
                this.runningTests.delete(suiteId);
                
                this.addToTimeline(`${suite.name} concluído: ${passed}/${suite.tests.length}`);
                this.addToLogs(`[${this.getCurrentTime()}] ${suite.name} concluído`);
                
                this.updateMetrics();
            }

            async runAllTests() {
                if (this.runningTests.size > 0) {
                    this.showNotification('Alguns testes já estão em execução', 'warning');
                    return;
                }

                this.showLoadingOverlay();
                this.startTime = Date.now();
                
                const suiteIds = Array.from(this.testSuites.keys());
                const parallelExecution = document.getElementById('parallelExecution').checked;
                
                if (parallelExecution) {
                    // Run tests in parallel
                    const promises = suiteIds.map(id => this.runTestSuite(id));
                    await Promise.all(promises);
                } else {
                    // Run tests sequentially
                    for (const id of suiteIds) {
                        await this.runTestSuite(id);
                        this.updateGlobalProgress(suiteIds.indexOf(id) + 1, suiteIds.length);
                    }
                }
                
                this.hideLoadingOverlay();
                this.showNotification('Todos os testes concluídos!', 'success');
            }

            updateGlobalProgress(current, total) {
                const progress = (current / total) * 100;
                const progressBar = document.getElementById('globalProgress');
                const progressText = document.getElementById('progressText');
                
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${current}/${total} suítes concluídas`;
            }

            updateMetrics() {
                let totalPassed = 0;
                let totalFailed = 0;
                let totalTests = 0;
                
                this.testResults.forEach(result => {
                    totalPassed += result.passed;
                    totalFailed += result.failed;
                    totalTests += result.total;
                });
                
                document.getElementById('tests-passed').textContent = totalPassed;
                document.getElementById('tests-failed').textContent = totalFailed;
                
                if (this.startTime) {
                    const duration = Math.round((Date.now() - this.startTime) / 1000);
                    document.getElementById('test-duration').textContent = `${duration}s`;
                }
                
                const coverage = totalTests > 0 ? Math.round((totalPassed / totalTests) * 100) : 0;
                document.getElementById('test-coverage').textContent = `${coverage}%`;
            }

            viewTestDetails(suiteId) {
                const suite = this.testSuites.get(suiteId);
                const result = this.testResults.get(suiteId);
                
                let content = `
                    <h5>${suite.name}</h5>
                    <p class="text-muted">${suite.tests.length} testes na suíte</p>
                `;
                
                if (result) {
                    content += `
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="text-center">
                                    <h3 class="text-success">${result.passed}</h3>
                                    <small>Aprovados</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <h3 class="text-danger">${result.failed}</h3>
                                    <small>Falharam</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <h3 class="text-info">${result.total}</h3>
                                    <small>Total</small>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                content += '<h6>Lista de Testes:</h6><ul class="list-group">';
                suite.tests.forEach(test => {
                    content += `<li class="list-group-item">${test}</li>`;
                });
                content += '</ul>';
                
                document.getElementById('testDetailsContent').innerHTML = content;
                
                const modal = new bootstrap.Modal(document.getElementById('testDetailsModal'));
                modal.show();
            }

            generateReport() {
                const report = {
                    timestamp: new Date().toISOString(),
                    summary: {
                        totalSuites: this.testSuites.size,
                        completedSuites: this.testResults.size,
                        totalTests: 0,
                        passedTests: 0,
                        failedTests: 0
                    },
                    suites: []
                };
                
                this.testResults.forEach((result, suiteId) => {
                    const suite = this.testSuites.get(suiteId);
                    report.summary.totalTests += result.total;
                    report.summary.passedTests += result.passed;
                    report.summary.failedTests += result.failed;
                    
                    report.suites.push({
                        id: suiteId,
                        name: suite.name,
                        category: suite.category,
                        ...result
                    });
                });
                
                // Download report as JSON
                const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `test-report-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.showNotification('Relatório gerado e baixado!', 'success');
            }

            initializeCharts() {
                const ctx = document.getElementById('coverageChart').getContext('2d');
                this.coverageChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Coberto', 'Não Coberto'],
                        datasets: [{
                            data: [85, 15],
                            backgroundColor: ['#28a745', '#dc3545']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            addToTimeline(message) {
                const timeline = document.getElementById('test-timeline');
                const item = document.createElement('div');
                item.className = 'timeline-item animate__animated animate__fadeInUp';
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span>${message}</span>
                        <small class="text-muted">${this.getCurrentTime()}</small>
                    </div>
                `;
                timeline.insertBefore(item, timeline.firstChild);
                
                // Keep only last 10 items
                while (timeline.children.length > 10) {
                    timeline.removeChild(timeline.lastChild);
                }
            }

            addToLogs(message) {
                const logs = document.getElementById('test-logs');
                const div = document.createElement('div');
                div.textContent = message;
                logs.appendChild(div);
                logs.scrollTop = logs.scrollHeight;
            }

            getCurrentTime() {
                return new Date().toLocaleTimeString('pt-BR');
            }

            showLoadingOverlay() {
                document.getElementById('loadingOverlay').style.display = 'flex';
            }

            hideLoadingOverlay() {
                document.getElementById('loadingOverlay').style.display = 'none';
            }

            showNotification(message, type = 'info') {
                const alertHtml = `
                    <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
                         style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', alertHtml);
                
                setTimeout(() => {
                    const alert = document.querySelector('.alert:last-of-type');
                    if (alert) alert.remove();
                }, 5000);
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Global functions
        function runAllTests() {
            window.testSystem.runAllTests();
        }

        function runTestSuite(suiteId) {
            window.testSystem.runTestSuite(suiteId);
        }

        function viewTestDetails(suiteId) {
            window.testSystem.viewTestDetails(suiteId);
        }

        function generateReport() {
            window.testSystem.generateReport();
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.testSystem = new TestSystemController();
        });
    </script>
</body>
</html>